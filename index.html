<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meshtastic Coverage Estimator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css"
    />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-providers@latest/leaflet-providers.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.2/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3.0.0/dist/d3-scale-chromatic.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"
      charset="utf-8"
    ></script>

    <style></style>
  </head>

  <body>
    <div id="map"></div>

    <div class="controls">
      <div class="controls-header" id="controls-header">
        <img src="images/drag_handle.png" alt="Drag handle" class="drag-handle"/>
      </div>
      <div class="controls-content" id="controls-content">
        <h3>Meshtastic Coverage Estimator</h3>

        <p>ITM / Longley-Rice model for estimating the range of your radio.</p>
        <p>
          Click on the map to select a location, then click run model. The colored tiles are where
          your signal can be received.
        </p>

        <label for="height">Height above ground (m):</label>
        <input type="text" id="height" value="1.0" />

        <label for="gain">Antenna gain (dB):</label>
        <input type="text" id="gain" value="2.0" />

        <label for="lat">Latitude (deg):</label>
        <input type="text" id="lat" value="51.000000" />

        <label for="lng">Longitude (deg):</label>
        <input type="text" id="lng" value="-114.000000" />

        <label for="region">Region:</label>
        <select id="region">
          <option value="US">US</option>
          <option value="EU_868">EU_868</option>
          <option value="EU_433">EU_433</option>
          <option value="ANZ">ANZ</option>
          <option value="CN">CN</option>
          <option value="IN">IN</option>
          <option value="JP">JP</option>
          <option value="KR">KR</option>
          <option value="MY_919">MY_919</option>
          <option value="MY_433">MY_433</option>
          <option value="NZ_865">NZ_865</option>
          <option value="RU">RU</option>
          <option value="SG_923">SG_923</option>
          <option value="TW">TW</option>
          <option value="TH">TH</option>
          <option value="UA_868">UA_868</option>
          <option value="UA_433">UA_433</option>
        </select>
        <p></p>

        <details advanced settings>
          <summary>Advanced Settings</summary>
          <label for="tx_power">Transmitter power (dBm):</label>
          <input type="text" id="tx_power" value="30" />

          <label for="frequency">Frequency (MHz):</label>
          <input type="text" id="tx_frequency" value="905.0" />

          <label for="rx_height">Receiver height above ground (m):</label>
          <input type="text" id="rx_height" value="1.0" />

          <label for="rx_gain">Receiver gain (dB):</label>
          <input type="text" id="rx_height" value="1.0" />

          <label for="additional_loss">Additional loss (dB):</label>
          <input type="text" id="additional_loss" value="0.0" />

          <label for="rx_sensitivity">Receiver sensitivity (dBm):</label>
          <input type="text" id="rx_sensitivity" value="-130.0" />
        </details>

        <button id="run-model-btn" onclick="predict()">Run Model</button>

        <hr />

        <p>Predicted Signal (dBm)</p>
        <div style="display: flex; justify-content: space-between">
          <span id="min-rssi">-140 (weak)</span>
          <span id="max-rssi">-90 (strong)</span>
        </div>
        <div class="color-bar" id="color-bar"></div>
        <br />

        <!-- About link -->
        <a href="#" id="about-link" onclick="openAboutDialog()">About</a>
      </div>
    </div>

    <!-- About dialog -->
    <dialog id="about-dialog">
      <h3>About</h3>
      <p>
        This tool calculates the ITM / Longley-Rice radio propagation model for Meshtastic LoRa
        radios (<a href="https://www.meshtastic.org" target="_blank">www.meshtastic.org</a>). Its
        purpose is to estimate the range of a Meshtastic radio, using a realistic physics and
        terrain model.
      </p>
      It is not affiliated with the Meshtastic project.

      <p>
        Source code:
        <a href="https://github.com/mrpatrick1991/meshtastic_linkplanner"
          >https://github.com/mrpatrick1991/meshtastic_linkplanner</a
        >
      </p>

      <p>
        An effort has been made to choose model parameters which are realistic for meshtastic
        devices. However, the model does not account for higher-order effects such as reflections
        from water, structures, or signal degradation by precipitation or vegetation. The results
        are approximate and should not be used for safety-critical applications.
      </p>

      <p>No location information is stored by this tool.</p>

      <h3>Acknowledgements</h3>
      <p>
        The propagation engine is based on work by the author of the
        <a href="https://github.com/JayKickliter/geoprop-py" target="_blank">geoprop-py</a>
        repository.
      </p>
      <p>
        This webpage uses the
        <a href="https://leafletjs.com" target="_blank">Leaflet</a> library.
      </p>
      <p>
        Terrain data is from the NASA Shuttle Radar Topography Mission (<a
          href="https://www.earthdata.nasa.gov/sensors/srtm"
          target="_blank"
          >SRTM</a
        >).
      </p>
      <p>
        The required experimental data were gathered using hardware and software designs from
        <a href="https://www.meshtastic.org" target="_blank">www.meshtastic.org</a>.
      </p>
      <p>
        High-performance computation is provided by Calgary Protospace (<a
          href="https://protospace.ca/"
          >https://protospace.ca</a
        >).
      </p>
      <p></p>
      <button onclick="closeAboutDialog()">Close</button>
    </dialog>
  </body>
  <script src="meshtastic-coverage.js"></script>
</html>
